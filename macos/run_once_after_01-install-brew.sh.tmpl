#!/bin/bash

{{- if eq .chezmoi.os "darwin" -}}

set -e

echo "========================================="
echo "Installing Homebrew and packages"
echo "========================================="

# Homebrewのインストール
echo "==> Checking Homebrew installation..."

if ! type brew &> /dev/null ; then
  # brewコマンドが見つからない場合
  if [[ -f "/opt/homebrew/bin/brew" ]]; then
    # Homebrewはインストール済みだがPATHが通っていない
    echo "Homebrew is installed but not in PATH. Configuring PATH..."
  else
    # Homebrewがインストールされていない
    echo "Homebrew not found. Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
else
  echo "Homebrew is already installed."
fi

# PATHを通す
if [ -f "$HOME/.zshrc" ]; then
  source "$HOME/.zshrc"
fi

# Brewfileからパッケージをインストール
echo ""
echo "==> Installing packages from Brewfile..."
BREWFILE="{{ .chezmoi.sourceDir }}/macos/Brewfile"

if [[ -f "${BREWFILE}" ]]; then
  brew bundle install --file="${BREWFILE}"
  echo "✓ Package installation complete."
else
  echo "Error: Brewfile not found at ${BREWFILE}"
  exit 1
fi

echo ""
echo "========================================="
echo "✓ Homebrew setup completed!"
echo "========================================="

{{ end -}}
